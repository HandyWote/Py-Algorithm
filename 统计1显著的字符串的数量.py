class Solution:
    def numberOfSubstrings(self, s: str) -> int:
        ans = 0
        n = len(s)
        total_ones = s.count('1')
        M = int(total_ones + (total_ones ** 0.5)) + 1
        for l in range(1, n+1):
            if l > M: break
            cnt1 = s[:l].count('1')
            cnt0 = l - cnt1
            if cnt1 >= cnt0 ** 2:
                ans += 1
            for i in range(l, n):
                left_char = s[i - l]
                right_char = s[i]
                if left_char == '1':
                    cnt1 -= 1
                else:
                    cnt0 -= 1
                if right_char == '1':
                    cnt1 += 1
                else:
                    cnt0 += 1
                if cnt1 >= cnt0 ** 2:
                    ans += 1
        return ans
    
    def numberOfSubstrings(self, s: str) -> int:
        n = len(s)
        ans = 0
        prefix0 = [0] * (n + 1)
        prefix1 = [0] * (n + 1)
        for i in range(1, n + 1):
            prefix0[i] = prefix0[i-1] + (1 if s[i-1] == '0' else 0)
            prefix1[i] = prefix1[i-1] + (1 if s[i-1] == '1' else 0)
        total_ones = prefix1[n]
        max_search_length = int(total_ones + (total_ones ** 0.5)) + 1
        for i in range(n):
            for j in range(i, min(n, i + max_search_length)):
                cnt0 = prefix0[j+1] - prefix0[i]
                cnt1 = prefix1[j+1] - prefix1[i]
                
                if cnt1 >= cnt0 ** 2:
                    ans += 1
                elif cnt0 > 0 and cnt1 < cnt0 ** 2 and (j+1 < n and s[j+1] != '1'):
                    remaining_ones = prefix1[n] - prefix1[j+1]
                    if cnt1 + remaining_ones < cnt0 ** 2:
                        break
        return ans


max = lambda a, b: b if b > a else a
class Solution:
    def numberOfSubstrings(self, s: str) -> int:
        pos0 = [-1]  # 哨兵，方便处理 cnt0 达到最大时的计数
        total1 = 0  # [0,r] 中的 1 的个数
        ans = 0

        for r, ch in enumerate(s):
            if ch == '0':
                pos0.append(r)  # 记录 0 的下标
            else:
                total1 += 1
                ans += r - pos0[-1]  # 单独计算不含 0 的子串个数

            # 倒着遍历 pos0，就相当于在从小到大枚举 cnt0
            for i in range(len(pos0) - 1, 0, -1):
                cnt0 = len(pos0) - i
                if cnt0 * cnt0 > total1:
                    break
                p, q = pos0[i - 1], pos0[i]
                cnt1 = r - q + 1 - cnt0  # [q,r] 中的 1 的个数 = [q,r] 的长度 - cnt0
                ans += max(q - max(cnt0 * cnt0 - cnt1, 0) - p, 0)

        return ans



    
def test():
    cases = {
        'input':[
            "00011",
            "101101",
            "11111111111110110111111111100111111011011111111111111111111111111111011111111011011110111110110111111011111111011111111101111011111111110111111101101111111001111111111101111011111111110111111111001011111111111111111111101111111111011111111111111111111010111101111111111111111111011111111111111111011111111100111111111111111111111111110111111101110101110101111111110111111111111111111110111111111111110111111111011111101101101111111101111100110111111111111111111101111111111111111111111111111011111111110111111111110111111111111111111111111101001111111001111111111011111111111111111111111111111111111111111111111011111111111111111111011111111111111111110111111111011111111111011111111111111111101111011011101111111111011111011101110101110101111111111011111110111101111110111111111101011111111011101111111100110111111111100111111111111111101101011111110111011111111111111110111111111101011011111111011111111111111011111111111111111111111111011111111110111011111011111111111111110111111101111111111111101111111111111111111101111111111101111111010111111111110110111111111011111111111101111111011111111111111111111111111111111111111111111111111111111111111111111111010111111111111111111111110111111111111011111111111111101011101111111111111111011111111111101111111111111111111111111111111111111111111111011111111111110111111111111011111111111101111101111110111111111111111111111111111111011111111111111111101101011111111111101001101110111111011111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011110111111011111111110110111111111111111110111010111111111111111111011111111101110111111111111001111111111011111111110111011111111111111111111011111101110110111111111100011101111101111111111111111111111111111111101001011111111111111111010011111101111111111111011111111111111011111111110111111111111111111011011111111111011111111111111111111111101110111110111111001111110111111101111111111111111101111111111111111010111011110111111111111111111111011111110111110111110111011111111111110011111111111111011111111111111011111101011111111101111111111111111111111111111111111111111110111101111111011111111011110001110111111111111101111111011111111111111111111111111110111111011111111111111111011011111011101111111111111111110110110111111111010111111101111111101110111101111011111111101111111110111111011111101111111111110111111111101111111011101111110111111111111111111111111101111111111110111111111111111111111111110111111111111111000101111111111011111011111111111111011111111111111111111111101011111111111111111111111111111111111110111101111111111111101111111111111101111011111111011111010111111111111100111111110111111010111111111111111111111111111111111111111111111111111111111111010111111111111101101111111101111111011111111011111111111110111111111111101111111101111111111111111111111111111111011111111011111111111101111111111101111111111111111111110111101101111111111111111111011111111111101111011111111111111111111101111111111111111111111101100111110111111111111111101111110111111111111101110111110011111111110111111101011110111111111111111111111111111111111111111111111111110111101111111111111011111111111110111111011101100111111111111111111111110111111111110101111111111111111111111101111101111111111011111111111111011111111111111111101110110111111111101111111111101111111111111111101111111111111110111011011111111111101111101111111111111111110111101111111111111111101101111111111101101111110111111111111111111111110111111110111111110101011111111110111111111111111111111111111111111110111111110111110111010111111101111111111101111111011111111111111111011110111111011111111101111111111111111111111111111110110111111101111111111111101111111101111011111111111111111111111101111"
        ],
        'output': [
            5,
            16,
            201987
        ]
    }
    s = Solution()
    for i, c in enumerate(cases['input']):
        print(f"\n=== Test {i+1}: {c} ===")
        result = s.numberOfSubstrings(c)
        expected = cases['output'][i]
        print(f"Result: {result}, Expected: {expected}")
        assert result == expected, f"Test {i+1} failed, expected {expected} but get {result}"
        print(f"Test {i+1} passed")    
    print('All test passed')

if __name__ == "__main__":
    test()